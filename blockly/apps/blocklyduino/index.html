<html lang="en">
<head>
  <meta charset="utf-8">
  <title>BlocklyDuino</title>
  <script type="text/javascript" src="blocks/blockly_compressed.js"></script>
  <script type="text/javascript" src="blocks/blocks_compressed.js"></script>
  <script type="text/javascript" src="blocks/arduino_compressed.js"></script>
  <script type="text/javascript" src="msg/js/en.js"></script>
  <script type="text/javascript" src="public/Blob.js"></script>
  <script type="text/javascript" src="library/FileSaver.min.js"></script>
  <script type="text/javascript" src="library/socket.io.js"></script>

  <script>

/**
 * List of tab names.
 * @private
 */
var TABS_ = ['blocks', 'arduino', 'xml'];

/**
 * INITIALIZATION
 */


/**
 * Initialize Blockly.  Called on page load.
 */
function init() {

    window.addEventListener('resize', resizeListener, false);
    // Restore saved blocks in a separate thread so that subsequent
    // initialization is not affected from a failed load.
    window.setTimeout(restoreBlocksListener, 0);
    // Hook a save function onto unload.
    window.addEventListener('unload', backupBlocksListener);


    // Init load event.
    var loadInput = document.getElementById('load');
    loadInput.addEventListener('change', loadXMLArduinoFileChangeListener, false);

    var toolbox = document.getElementById('toolbox');
    Blockly.inject(document.getElementById('content_blocks'),
        {grid:
            {spacing: 25,
                length: 3,
                colour: '#ccc',
                snap: true},
            media: '../../media/',
            toolbox: toolbox});

    selectWorkSpaceShown();
}


/**
 * SOCKETS
 */

/**
 * Code that hooks up the hooks sockets
 */
var socket = io.connect(':3000');
socket.on('connection', function (socket) {
    console.log('socket connectted');
});

socket.on('usb-ports', function (usbPorts) {
    document.querySelector('#com-ports').innerHTML = "";
    for (var i = 0; i < usbPorts.length; i += 1) {
        let opt = document.createElement('option');
        var name = isArduino(usbPorts[i]) ? '(Arduino) ' : '';
        name += usbPorts[i].comName
        opt.value =  i;
        opt.innerHTML = name;
        document.querySelector('#com-ports').appendChild(opt);
    }
});

socket.on('serial-monitor', function(data) {
    var div = document.querySelector('#text_from_serial_monitor');
    div.innerHTML = div.innerHTML + data;
    console.log(data);
});

socket.on('uploaded', function (uploaded) {
    var message = uploaded ? 'Your code was successfully uploaded.' :
        'There was an error uploading your code. Please check the blocks.';
    alert(message);
});

socket.on('debug-block', function (blockNumber) {
    var blocks = Blockly.mainWorkspace.getAllBlocks();

    for (var i = 0; i < blocks.length; i += 1) {
        if (blocks[i].id == blockNumber) {
            blocks[i].setColour(450);
            blocks[i].select();
            continue;
        }

        if (blocks[i].type === 'debug') {
            blocks[i].setColour(210);
        }
    }
});



/***
 * HELPERS
 */

/**
 * Switch the visible pane when a tab is clicked.
 * @param {string} selectedArea Name of tab clicked.
 */
function selectWorkSpaceShown(selectedArea = 'blocks') {
    for (var i = 0; i < TABS_.length; i++) {
        var name = TABS_[i];
        document.getElementById('tab_' + name).className = 'taboff';
        document.getElementById('content_' + name).style.visibility = 'hidden';
    }

    document.getElementById('tab_' + selectedArea).className = 'tabon';
    document.getElementById('content_' + selectedArea).style.visibility = 'visible';
    renderContent(selectedArea);
}

/**
 * Populate the currently  pane with content generated from the blocks.
 */
function renderContent(selectedArea = 'blocks') {
    Blockly.mainWorkspace.setVisible(false);
    // Initialize the pane.
    if (selectedArea == 'blocks') {
        Blockly.mainWorkspace.setVisible(true);
        // If the workspace was changed by the XML tab, Firefox will have performed
        // an incomplete rendering due to Blockly being invisible.  Rerender.
        Blockly.mainWorkspace.render();
    } else if (selectedArea == 'xml') {
        var xmlTextArea = document.getElementById('content_xml');
        var xmlDom = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
        xmlTextArea.value = Blockly.Xml.domToPrettyText(xmlDom);
        xmlTextArea.focus();
    } else if (selectedArea == 'arduino') {
        var arduinoTextArea = document.getElementById('content_arduino');
        arduinoTextArea.value = Blockly.Arduino.workspaceToCode();
        arduinoTextArea.focus();
    }
}

/**
 * This returns true if the serial port is an arduino
 * @param port
 * @returns {boolean}
 */
function isArduino(port) {
    return typeof port.manufacturer !== 'undefined' && port.manufacturer.indexOf('Arduino') > -1;
}

/**
 * This upload the code to the node server
 */
function uploadCode(code) {

    document.querySelector('#text_from_serial_monitor').innerHTML = '';
    var arduinoUSBPort = document.querySelector('#com-ports').value;
    var request = new XMLHttpRequest();

    request.open("POST", "http://127.0.0.1:3000/upload-code/" + arduinoUSBPort, true);
    request.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
    request.send(code);
}

/**
 * This goes through all the debug blocks and clears them out
 */
function clearDebugBlocks() {
    var blocks = Blockly.mainWorkspace.getAllBlocks();
    Blockly.selected.unselect();
    for (var i = 0; i < blocks.length; i += 1) {
        if (blocks[i].type === 'debug') {
            blocks[i].setColour(210);
        }
    }
}

/**
 * Event Listener Function
 */


/**
 * Load blocks from local file.
 */
function loadXMLArduinoFileChangeListener(event) {
    var files = event.target.files;
    // Only allow uploading one file.
    if (files.length != 1) {
        return;
    }

    // FileReader
    var reader = new FileReader();
    reader.onloadend = function(event) {
        var target = event.target;
        // 2 == FileReader.DONE
        if (target.readyState == 2) {
            try {
                var xml = Blockly.Xml.textToDom(target.result);
            } catch (e) {
                alert('Error parsing XML:\n' + e);
                return;
            }
            var count = Blockly.mainWorkspace.getAllBlocks().length;
            if (count && confirm('Replace existing blocks?\n"Cancel" will merge.')) {
                Blockly.mainWorkspace.clear();
            }
            Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
        }
        // Reset value of input after loading because Chrome will not fire
        // a 'change' event if the same file is loaded again.
        document.getElementById('load').value = '';
    };
    reader.readAsText(files[0]);
}


/**
 * Backup code blocks to localStorage. Used in unload window event
 */
function backupBlocksListener() {
    if ('localStorage' in window) {
        var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
        window.localStorage.setItem('arduino', Blockly.Xml.domToText(xml));
    }
}

/**
 * Restore code blocks from localStorage.
 */
function restoreBlocksListener() {
    if ('localStorage' in window && window.localStorage.arduino) {
        var xml = Blockly.Xml.textToDom(window.localStorage.arduino);
        Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
    }
}

/**
 * Controls the resizing
 */
function resizeListener() {
    var body = document.getElementsByTagName('body')[0];
    for (var i = 0; i < TABS_.length; i++) {
        var el = document.getElementById('content_' + TABS_[i]);
        el.style.top = document.getElementById('menu').offsetHeight;
        el.style.left = '0px';
        // Height and width need to be set, read back, then set again to
        // compensate for scrollbars.
        el.style.height = body.offsetHeight  + 'px';
        // This done to see the trash can
        el.style.height = (2 * body.offsetHeight - el.offsetHeight - 60) + 'px';
        el.style.width = body.offsetWidth + 'px';
        el.style.width = (2 * body.offsetWidth - el.offsetWidth) + 'px';
    }
};


/**
 * CLICK LISTENERS
 */


/**
 * Toggles the visibility of the serial monitor
 */
function toggleDebugClick() {
    var debugElement = document.querySelector('#content_serial_monitor');
    var contentBlock = document.querySelector('#content_blocks');
    if (debugElement.style.display === 'none') {
        debugElement.style.display = 'block';
        contentBlock.style.width = '50%!important';
    }  else {
        debugElement.style.display = 'none';
        contentBlock.style.width = '100%!important';
    }
}

/**
 * Clears out the serial monitor
 */
function clearSerialMonitorClick() {
    var debugElement = document.querySelector('#content_serial_monitor pre');
    debugElement.innerHTML = '';
}

/**
 * Save blocks to local file.
 * better include Blob and FileSaver for browser compatibility
 */
function saveClick() {
    var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
    var data = Blockly.Xml.domToText(xml);
    var fileName = window.prompt('What would you like to name your file?', 'BlocklyDuino');
    // Store data in blob.
    // var builder = new BlobBuilder();
    // builder.append(data);
    // saveAs(builder.getBlob('text/plain;charset=utf-8'), 'blockduino.xml');
    if(fileName){
        var blob = new Blob([data], {type: 'text/xml'});
        saveAs(blob, fileName + ".xml");
    }
}

/**
 * Discard all blocks from the workspace.
 */
function discardClick() {
    var count = Blockly.mainWorkspace.getAllBlocks().length;
    if (count < 2 || window.confirm('Delete all ' + count + ' blocks?')) {
        Blockly.mainWorkspace.clear();
        renderContent();
    }
}

/**
 * This sends a request to the node server to continue
 */
function debugContinueClick() {
    clearDebugBlocks();
    var request = new XMLHttpRequest();

    request.open('GET', 'http://127.0.0.1:3000/continue', true);
    request.onreadystatechange = function () {
        if (request.readyState === 4 && request.responseText == 'serial-port-not-there') {
            alert('There was an error connecting with your arduino please re upload the program.');
        }
    };
    request.send();

}

/**
 * This uploads the code created by the blocks to the arduino
 */
function uploadClick() {
    uploadCode(Blockly.Arduino.workspaceToCode());
}

/**
 * This uploads a blank sketch to the arduino
 */
function resetClick() {
    uploadCode("void setup() {} void loop() {}");
}

/**
 * This changes the work space
 */
function tabClick(selectedAreaName) {
    selectWorkSpaceShown(selectedAreaName);
}

/**
 * Loads a new xml file
 */
function loadFileClick() {
    document.getElementById('load').click();
}


  </script>
  <style>
    html, body {
      height: 100%;
    }
    body {
      background-color: #fff;
      font-family: sans-serif;
      margin: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
      margin-left: 5px;
      margin-right: 5px;
    }
    .tabon {
      border-bottom-color: #ddd !important;
      background-color: #ddd;
      padding: 5px 19px;
    }
    .taboff {
      cursor: pointer;
      padding: 5px 19px;
    }
    .taboff:hover {
      background-color: #eee;
    }
    .content {
      visibility: hidden;
      margin: 0;
      padding: 1ex;
      position: absolute;
      direction: ltr;
    }
    pre.content {
      overflow: scroll;
    }
    #content_blocks {
      padding: 0;
    }
    .blocklySvg {
      border-top: none !important;
    }
    #content_xml {
      resize: none;
      outline: none;
      border: none;
      font-family: monospace;
      overflow: scroll;
    }
    button {
      padding: 1px 1em;
      font-size: 90%;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: #eee;
      color: black;
    }
    button.launch {
      border: 1px solid #d43;
      background-color: #d43;
      color: white;
    }
    button:active {
      border: 1px solid blue !important;
    }
    button:hover {
      box-shadow: 2px 2px 5px #888;
    }

    #content_serial_monitor {
      width: 48%;
      height: 400px;
      border: solid red 2px;
      z-index: 1;
      position: absolute;
      left: 48%;
      top: 68px;
      background: white;
      overflow-y: scroll;
    }

    #content_serial_monitor h3 {
       font-size: 1em;
       text-align: center;
    }

    #continue-block, #clear-serial-monitor {
       width: 48%;
       font-size: 2em;
       font-weight: bold;
      margin-left: 1%;
    }
    #tabs {
      width: 40%;
      display: inline-block;
    }

    #tabs div {
        width: 116px;
        height: 25px;
        display: inline-block;
    }

    #controls {
      display: inline-block;
    }

    #menu {
      height: 70px;
    }
    h1 {
      height: 30px;
      margin: 5px;
    }
  </style>
</head>
<body onload="init()">
  <header id="menu">
    <h1>
      Arduino Blockly IDE (Forked From <a href="">BlockyDuino</a>) | <a href="">Actual Code</a>
    </h1>
    <div id="tabs">
      <div id="tab_blocks" class="tabon" onclick="tabClick('blocks')">Blocks</div>
      <div id="tab_arduino" class="taboff" onclick="tabClick('arduino')">Arduino</div>
      <div id="tab_xml" class="taboff" onclick="tabClick('xml')">XML</div>
    </div>
    <div id="controls">
      <select id="com-ports">

      </select>
      <button type="button" onclick="toggleDebugClick()">Debugger</button>
      <button type="button" onclick="uploadClick()">Upload</button>
      <button type="button" onclick="resetClick()">Reset</button>
      <button onclick="discardClick()">Discard</button>
      <button onclick="saveClick()">Save</button>
      <button onclick="loadFileClick()" id="fakeload">Load</button>
      <input type="file" id="load" style="display: none;"/>
      <!--button class="launch" onclick="runJS()">Run Program</button-->
    </div>
  </header>

  <div id="content_serial_monitor" style="display: none;">
    <h3>Logging \ Debugging Window </h3>
    <button id="continue-block" onclick="debugContinueClick()">Continue Debug</button>
    <button id="clear-serial-monitor" onclick="clearSerialMonitorClick()">Clear Window</button>

    <pre id="text_from_serial_monitor"></pre>
  </div>

  <div id="content_blocks" class="content"></div>
  <textarea id="content_arduino" class="content" readonly wrap="off"></textarea>
  <textarea id="content_xml" class="content" wrap="off"></textarea>

  <xml id="toolbox" style="display: none">
    <category name="Logic">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_null"></block>
    </category>
    <category name="Control">
      <block type="base_delay">
        <value name="DELAY_TIME">
          <block type="math_number">
            <field name="NUM">1000</field>
          </block>
        </value>
      </block>
      <block type="controls_for">
        <value name="FROM">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
        <value name="TO">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
        <value name="BY">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Math">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="base_map">
        <value name="DMAX">
          <block type="math_number">
            <field name="NUM">180</field>
          </block>
        </value>
      </block>
    </category>
    <category name="Lists">
      <block type="lists_create_with"></block>
      <block type="lists_getIndex"></block>
      <block type="lists_setIndex"></block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>


    </category>
    <category name="Text">
      <block type="text"></block>
      <block type="text_join"></block>
    </category>
    <category name="Variables" custom="VARIABLE"></category>
    <category name="Global Variables" >
      <block type="variables_global"></block>

    </category>
    <category name="Debug" >
      <block type="debug"></block>

    </category>

    <category name="Functions" custom="PROCEDURE"></category>
    <sep></sep>
    <category name="Input/Output">
      <block type="inout_highlow"></block>
      <block type="inout_digital_write"></block>
      <block type="inout_digital_read"></block>
      <block type="inout_digital_read_pullup_resistor"></block>
      <block type="inout_analog_write">
        <value name="NUM">
          <block type="math_number">
            <field name="NUM">0</field>
          </block>
        </value>
      </block>
      <block type="inout_analog_read"></block>
      <block type="serial_print">
        <value name="CONTENT">
          <block type="text">
            <field name="TEXT"></field>
          </block>
        </value>
      </block>
      <block type="inout_tone">
        <value name="NUM">
          <block type="math_number">
            <field name="NUM">440</field>
          </block>
        </value>
      </block>
      <block type="inout_notone"></block>
      <block type="inout_pulse_in"></block>
      <block type="inout_buildin_led"></block>
    </category>
    <category name="Servo">
      <block type="servo_move">
        <value name="DEGREE">
          <block type="math_number">
            <field name="NUM">0</field>
          </block>
        </value>
      </block>
      <block type="servo_read_degrees"></block>
    </category>
    <!--<category name="Grove Analog">-->
      <!--<block type="grove_rotary_angle"></block>-->
      <!--<block type="grove_temporature_sensor"></block>-->
      <!--<block type="grove_sound_sensor"></block>-->
      <!--<block type="grove_thumb_joystick"></block>-->
    <!--</category>-->
    <!--<category name="Grove">-->
      <!--<block type="grove_led"></block>-->
      <!--<block type="grove_button"></block>-->
      <!--<block type="grove_relay"></block>-->
      <!--<block type="grove_tilt_switch"></block>-->
      <!--<block type="grove_piezo_buzzer"></block>-->
      <!--<block type="grove_pir_motion_sensor"></block>-->
      <!--<block type="grove_line_finder"></block>-->
      <!--<block type="grove_rgb_led"></block>-->
      <!--<block type="grove_ultrasonic_ranger"></block>-->
    <!--</category>-->
    <!--<category name="Grove LCD">-->
      <!--<block type="grove_serial_lcd_print">-->
        <!--<value name="TEXT">-->
          <!--<block type="text">-->
            <!--<field name="TEXT"></field>-->
          <!--</block>-->
        <!--</value>-->
        <!--<value name="TEXT2">-->
          <!--<block type="text">-->
            <!--<field name="TEXT"></field>-->
          <!--</block>-->
        <!--</value>-->
        <!--<value name="DELAY_TIME">-->
          <!--<block type="math_number">-->
            <!--<field name="NUM">1000</field>-->
          <!--</block>-->
        <!--</value>-->
      <!--</block>-->
      <!--<block type="grove_serial_lcd_power"></block>-->
      <!--<block type="grove_serial_lcd_effect"></block>-->
    <!--</category>-->
    <!--<category name="Grove Motor">-->
      <!--<block type="grove_motor_shield"></block>-->
    <!--</category>-->
    <category name="LCD Screens">

      <block type="liquid_crystal_ic2_lcd_setup">
        <value name="Number of Rows">
          <block type="math_number">
            <field name="NUM">4</field>
          </block>
        </value>
        <value name="Number of Columns">
          <block type="math_number">
            <field name="NUM">20</field>
          </block>
        </value>
      </block>

      <block type="liquid_crystal_ic2_lcd">
        <value name="Row 1">
          <block type="text">
            <field name="TEXT"></field>
          </block>
        </value>
        <value name="Row 2">
          <block type="text">
            <field name="TEXT"></field>
          </block>
        </value>
        <value name="Row 3">
          <block type="text">
            <field name="TEXT"></field>
          </block>
        </value>
        <value name="Row 4">
          <block type="text">
            <field name="TEXT"></field>
          </block>
        </value>
        <value name="Delay Time">
          <block type="math_number">
            <field name="NUM">3000</field>
          </block>
        </value>
      </block>
      <block type="liquid_crystal_ic2_lcd_backlight">

    </block>
      <block type="liquid_crystal_ic2_lcd_clear">

      </block>
      <block type="liquid_crystal_ic2_lcd_set_cursor"></block>
      <block type="liquid_crystal_ic2_lcd_print"></block>
      <block type="liquid_crystal_ic2_lcd_blink"></block>
      <block type="liquid_crystal_ic2_lcd_scroll_left"></block>
      <block type="liquid_crystal_ic2_lcd_scroll_right"></block>


    </category>

  </xml>
</body>
</html>
